#ifndef ALLVARS_H
#define ALLVARS_H

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <math.h>
#include <time.h>
#include <sys/time.h>
#include <sys/resource.h>
#include <sys/types.h>
#include <sys/stat.h>
#include <unistd.h>
#include <signal.h>
#include <errno.h>
#include <dirent.h>
#include <regex.h>

typedef unsigned long long MyIDtype;


static MyIDtype MAXUSEABLE = 18446744073709551614;
static MyIDtype NULLPOINT =  18446744073709551615;

static MyIDtype MAXHALOPERSNAP = 1000000000000;

static double kpc2km = 3.08567758e16;
static double year2second = 365.25*24*3600;

static double p_mass = 9.36395e+08;
static double h = 0.704;
static double Mpc2kpc = 1000.;
static double HBT2AHFmass = 1.e10;

static double Boxsize= 62500.;

#define MAX(x, y) (((x) > (y)) ? (x) : (y))
#define MIN(x, y) (((x) < (y)) ? (x) : (y))

//configuration


#define MAXSTRING 1024

#define FIRSTSNAP 0
#define LASTSNAP 61
#define NSNAPS 62

struct progtable 
{
  MyIDtype haloID;
  MyIDtype nProgs;
  MyIDtype *progID;
};

struct outputRAW
{
  float outputFormat;
  char filename[MAXSTRING];
  struct tm* timestamp;
  char Descriptions[MAXSTRING];
  unsigned int TotNsnapshots;
  unsigned int FirstSnapshot;
  unsigned int LastSnapshot;
  MyIDtype nHalos;
  struct progtable *progs;
};

struct HALOPROPS
{
  MyIDtype  ID;
  unsigned int SnapID;
  MyIDtype   hostHalo;
  MyIDtype  numSubStruct;
  MyIDtype  nAvatars;
  MyIDtype *AvatarList;
  int ProgAvatarFlag;
  int TroubleFlag;
  float Mvir;
  MyIDtype npart;
  struct particle_data *Particles;
  float Xc, Yc, Zc;
  float VXc, VYc, VZc;
  float Rvir, Rmax;
  float r2;
  float mbp_offset, com_offset;
  float Vmax, v_esc, sigV;
  float lambda, lambdaE;
  float Lx, Ly, Lz;
  float b,c;
  float Eax, Eay, Eaz;
  float Ebx, Eby, Ebz;
  float Ecx, Ecy, Ecz;
  float ovdens;
  float nbins;
  float fMhires;
  float Ekin, Epot;
  float SurfP;
  float Phi0;
  float cNFW;
};

struct AvatarTable
{
  MyIDtype MainAvatar;
  MyIDtype MainProg;
  MyIDtype NextProg;
  MyIDtype MainProgMerging;
};

struct SNAPSHOT_STATS 
{
  float Vmax;
  float Vrms;
  float *radbin, *xi;
  float *massbin, *massfunction;
};


struct particle_data
{
  MyIDtype ParticleID;
  float ParticleEnergy;
  float X,Y,Z;
  float Vx,Vy,Vz;
};

struct HBT_halos
{
  MyIDtype SubHaloID;
  unsigned int SnapID;
  MyIDtype HostID;
  long long AHFID;
  MyIDtype Nbound;
  float RvirEstimate;
  float Vmax;
  float Rmax;
  float X;
  float Y;
  float Z;
  float Vx;
  float Vy;
  float Vz;
  float Mvir;
  float Rvir;
  float Rhalf;
  float RPoisson;
  float R2Sig;
  float Req;
  float Rtidal;
};
extern struct HBT_halos *HBT;


extern struct SNAPSHOT_STATS snap_stats[NSNAPS];
extern void get_snap_stats();

extern struct outputRAW output;

extern MyIDtype TotNavatars;
extern MyIDtype *Avatar;

extern char delFile[MAXSTRING];
extern char addFile[MAXSTRING];
extern char SnapTimeFile[MAXSTRING];

extern char FilePrefix[MAXSTRING];
extern char FolderName[MAXSTRING];
extern char TreeFolder[MAXSTRING];
extern char ppFolder[MAXSTRING];

extern MyIDtype SnapNhalos[NSNAPS];
extern float snapTime[NSNAPS];
extern float snapTimeYear[NSNAPS];
extern float expansion_factor[NSNAPS];
extern MyIDtype TotNhalos;
extern MyIDtype TotNhalosUsed;

extern MyIDtype *IDmap;
extern MyIDtype *SubTree;

extern struct HALOPROPS *HaloTable;
extern char inputFile[MAXSTRING];

extern void calculateMassFunction();
extern void merger_analysis(float minmass, float maxmass, int highlim_npart);
extern void snapshot_stats(int snapid, float minmass, float maxmass, int highlim_npart);
extern void main_branch_analysis(float minmass, float maxmass, int highlim_npart);
extern void count_mergers(MyIDtype haloid, int nStep, double binsize);

extern void getSnapTime();
extern void makeIDmap();
extern void deleteHalos_v1(char file[MAXSTRING]);
extern void addHalo_v1(char file[MAXSTRING]);
extern void resetIDmap();
extern void getFilename(char* filename,unsigned int snapnum);
extern void load_particles(MyIDtype load_id);
extern void read_particles(unsigned int slotid);
extern void hbtmaphalos(char file[MAXSTRING]);


extern int readRawOutputs(char file[MAXSTRING]);
extern MyIDtype assignAvatarMain();
extern MyIDtype assignAvatar();


extern int compareParticleEnergy(const void *v1, const void *v2);
extern int compareHaloID(const void *v1, const void *v2);
extern int compareID(const void *v1, const void *v2);
extern int compareMyIDType(const void *v1, const void *v2);
extern MyIDtype IDsearch( MyIDtype searchKey );

extern void printoutprofile();
extern void printouttrees();
extern void printoutparticles_binary();
#endif
